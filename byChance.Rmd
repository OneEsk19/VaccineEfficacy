---
title: "Efficacy Due to Chance?"
author: "G.Robertson"
date: "03/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Could the Covid 19 efficacy be due to chance alone?

### The Pfizer & bioNTech vaccine
####Trial parameters
*43,000 participants
*Split evenly into placebo and vaccine groups
      + = 21,500 control, and 21,500 vaccine
* Total covid cases across all participants
      + = 170
      + 8 cases in vaccine trial
      + 162 in placebo trial
      
#### Vaccine efficacy achieved
* = 95%

#### Basic vaccine efficacy formula
* VE = ((ARU - ARV) / ARU) * 100, where:
      + ARU = infections in placebo group / number in group
      + ARV = infections in Vaccinated / number in group
      
      
### Simulating if the vaccine efficacy could be purely down to random chance.

Assumptions:
* The vaccine is ineffective
* Therefore infections are equally likely in either group

Model Method:
```{r}
# Create the full trial population of 43,000 individuals in which there are 162 infected with covid19

# assigning: infected = 1, not infected = 0
population <- c(replicate(162, 1), replicate(42838, 0))
# divide the population in half to simulate the two groups by random sampling of 21500 individuals
testsample <- sample(population, 21500)
# calculate total ppositive cases in simulated placebo group
placebo <- sum(testsample)
# calculate total positive cases in simulated vaccinated group
vaccinated <- 162 - placebo
# calculate efficacy of vaccine in this experiment
efficacy <- ((placebo - vaccinated)/vaccinated) *100
print(efficacy)
```
Turn this process into a loop so that many simulations can be run. In this example, it will run 10,000 simulations.
```{r}
# how many times the simulation should run
nruns <- 10000
# initialise vector to hold results
eff_res <- rep(0, nruns)
# create the loop
for (i in 1:nruns) {
      testsample <- sample(population, 21500) 
      placebo <- sum(testsample)
      vaccinated <- 162 - placebo
      efficacy <- ((placebo - vaccinated)/vaccinated) *100
      eff_res[i] <- efficacy
}
```

Lets have a look at the distribution of the simulations
```{r}
# required library
library(ggplot2)
```

```{r}
efficacies <- data.frame(eff_res)
     
ggplot(efficacies, aes(x = eff_res))+
      geom_histogram(bins = 30, col = "black",
                     fill = "lightblue")+
      labs(title = "If vaccine efficacy was due to chance",
           x = "Vaccine Efficacy", 
           y = "Occurences in 10000 simulations")
```
Assuming that the vaccine is not effective, how many times can it have an efficacy of over 90% in 10,000 clinical trials?
```{r}
# How many simulations result in eff > 90?
abv_90 <- efficacies[efficacies$eff_res >90,]
howmany <- length(abv_90) 
```
```{r}
print("in 10000 (simulated) clinical trials $howmany produced a vaccine efficacy of over 90% purely by chance")
```

